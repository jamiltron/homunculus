package com.jamiltron.homunculus.model;

import com.badlogic.gdx.math.Vector2;
import com.badlogic.gdx.utils.Array;
import com.jamiltron.homunculus.model.Color;
import java.util.Map;
import java.util.HashMap;
import java.util.Random;

public class World {
  private Color[] colors = Color.values();
  private Array<Homunculus> homunculi = new Array<Homunculus>();
  private Array<Spell> setSpells = new Array<Spell>();
  private Array<Color> colorGrid = new Array<Color>();
  private Spell activeSpell = null;
  private Spell nextSpell   = null;
  private Random random = new Random();
  
  public Color getGrid(float x, float y) {
    int iy = 17 - ((int)y - 2);
    int ix = (int)x - 2;
    
    return colorGrid.get(8 * iy + ix);
  }
  
  public void putGrid(Color c, float x, float y) {
    int iy = 17 - ((int) y - 2);
    int ix = (int)x - 2;
    
    colorGrid.set(8 * iy + ix, c);
  }
  
  public World(int numHomunculi) {
    createWorld(numHomunculi);
  }
  
  public Array<Homunculus> getHomunculi() {
    return homunculi;
  }
  
  public Spell getNextSpell() {
    return nextSpell;
  }
  
  public Spell getActiveSpell() {
    return activeSpell;
  }
  
  public Array<Spell> getSetSpells() {
    return setSpells;
  }
  
  public Spell generateSpell() {
    int i = colors.length;
    Color color1 = colors[random.nextInt(i)];
    Color color2 = colors[random.nextInt(i)];
    Component component1 = new Component(12, 19, color1);
    Component component2 = new Component(13, 19, color2);
    return new Spell(component1, component2);
  }
  
  public void setActiveSpell(Spell spell) {
    activeSpell = spell;
  }
  
  public void restSpell() {
    if (activeSpell != null) {
      setSpells.add(activeSpell);
    }
    activateSpell(nextSpell);
    activeSpell = nextSpell;
    nextSpell = generateSpell();
  }
  
  public void activateSpell(Spell spell) {
    spell.component1.pos.x = 5;
    spell.component1.pos.y = 19;
    
    spell.component2.pos.x = 6;
    spell.component2.pos.y = 19;
  }
  
  private void createWorld(int numHomunculi) {
    Boolean inserted;
    Color color;
    float x, y;
    Map<Vector2, Boolean> places = new HashMap<Vector2, Boolean>();
    Vector2 vector = new Vector2(0, 0);
    
    for (int i = 0; i < 8 * 16; i++) {
      colorGrid.add(null);
    }
    
    // create random homunculi
    for (int i = 0; i < numHomunculi; i++) {
      inserted = false;
      do {
        x = (float)(random.nextInt(8)  + 2);
        y = (float)(random.nextInt(13) + 2);
        vector.set(x, y);

        if (places.get(vector) == null) {
          places.put(vector, true);
          inserted = true;
          color = colors[i % colors.length];
          homunculi.add(new Homunculus((float)x, (float)y, color));
        }
      } while (!inserted);
    }
    nextSpell = generateSpell();
  }
}
